#!/bin/bash

# Use like this:
# ./deploy demo organia-frontend master
# ./deploy prod organia-server abcdef12

set -eux

environment=$1
shift

project=$1
shift

target=$1
shift

image="$project:$environment"
container="$project-$environment"

cd "$HOME/$environment/$project"

git fetch
git checkout "$target"
podman build . -t "$project:$environment"
podman rm -f "$container"

if [ "$project" == 'organia-frontend' ]; then
	podman run --rm --name "$container" -v "/app/dist:/srv/organia-frontend/$environment" "$image"
fi

if [ "$project" == 'organia-server' ]; then
	if [ "$environment" == 'prod' ]; then
		port=8001
	elif [ "$environment" == 'dev' ]; then
		port=8002
	elif [ "$environment" == 'demo' ]; then
		port=8003
	else
		echo Unknown environment \"$environment\" >&2
		exit 1
	fi
	podman run -d --rm --name "$container" -p "$port:8000" "$image"
fi
